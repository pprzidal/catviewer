<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'"> -->
    <title>CatViewer</title>
    <link href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAABjgKIAHh23AKm9zwCOrcQAlqq7AAABDABlhKUAU3SIACEeugCeqa8AIyC3AAEHDAAPGTgAOEJgACYhugCFnK0AWlO+AAMHFQBAM8sAQTPLAJS00ACNnacAQjTOAC0lvQB6iJ8ANk5yAHWNpQBNYIMAusfSABUlQQAwJ8MAgbHIAKe8xAAXJlYAHx6yAGp7nQCAiLoAr7vKAJavuQAjILgAV3GJACchuwBccowAIiVlADFHeQB9o8MAY22PAIqTwACGprEAIUFWAC4mwQCCg5oAhZ/JAC1SiAAwJ8QANlCCABobswBnd5sANCrEACFCawAcJUIAhq7JAEFTcACuuMIAPFZ5AElGdgAzMGsAgIi7ACVAdwAhKEsAOi/KAEVWeQA7L8oAU3WNAFlwhwAjILkAqsbRAKCtvQCFnbIASGB8AIaauwBJUZcArMnjAFh3nACQnakAnbbGAB47YABvk6cAcZOnAJHC2AByk6cAm7rSADJRfQBylKoAFxqxAD9QcQBMcoUANSrFAHubpAB9kq0AISZGAA4VLwAhH7cAr7vMACIftwAJHzIAS0yAAJiuwQBFWIAAL05jAC1HcgBfUbIAc36oALPFzwBzdboAKiS9AHOEqABbeZEALCXAALPN1QBvk6gARTnOAH+RkAAWGrIAX4CUAAMRLQBmcZ0AYoCUAH2KqAB0l6sANCnDAAoUJABQZo8AZ36XAJaosABGUGkAZmvBADgtxgA5LcYAiLTUAGmJnQBXa5UAboiaACYhvgCUtMsAKCW4AEdTlgA3TmQAKyS+ACsxVgAxKr4AobrLAGBR4ABfhJgAcGahAJegvQCsvsUAbn2VAEZTcwAhH7kAIh+5ABYxYACNs9IAsr/RAHCGngBFUpQAKk53AFhfugASHD0Ao7G6ACokvwCRnKkAESFDACUzXQCKqLsAEShPADMowgCOp7gAFShPAGOEmQAEFjUAGChPAEFabgB0l78ADhUpAIyKoQAhHrcAfKKqAClFeABwh5kABQUVAFZG3AApI70AKyTAAICnwgCVu9kAkZ+8AD9NdQBBTHIASnKJAAQXMAA8SY0ArbjHAHebsQBTbYwAcXyUACEeuAALFzkAK0NzACUhuACCm7EAqMXcACknrwBvi50AMUxzACwkwQAuJr4AusXTAG+RrwAFCSsAJzdZADdCiwCDq8YAjKe6AISozwCNq70ACRQxAF5chwBBT3wAaFvUAFZthAAgHrkAirHPAIuv0gBqWuMAkbPMAISdrwB8fJUAJyK8AJmxxgAmL1QAFhmrAIGrvgC1z9cAMCfCAKa0xgAgP2kAESdPAEBCgwC90NoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAn5F/YEnHSk+zeF3VempeewiSjrZsGTFtB5mBuxXtCjigyeYqLAZXWHxa0jAJuSfxS0p1NDct6MLLjOxiqzPnIqoo8um34IvDFOGxJqkYAQqP3esdPaLafZMCICWcUdHOKcGuA95ZH98EZ00PpFRmupTXTpBbUtOXyvVrYyOd7sAO1BrvTPN3+RzZcVWFvS5zaDmAo0MkL3I/m5SCfobNlhdwDvQ62DJ2HjI2SIoWEhCqsIlGYRO/6uVv+EIrpZqneZiI9huHlcUNqIPiPKHEvKbW3DueuEHkRWTbvhH30DXPPl9cxuMhjWUFbguttLJEacxTAFBHdPBAVoQMyLWsrwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=" rel="icon" type="image/x-icon" />
  </head>
  <body>
    <center><h1>Welcome! üê±</h1><br><img id="image" alt="MDN"><br><br>
    <label for="framerate">Framerate</label>
      <input id="framerate" type="number">                          
      <button id="bla" onclick="sendFramerate()">Send Framerate</button><br>
      <button onclick="toggleLed()">Toggle Led</button><br>
      <a href="/logout"><button>Logout</button></a></center> <!-- TODO: place this button better -->
    <script>
      const ledToggleTimeout = 6000; // in ms
      let lastTime = 0;
      const image = document.getElementById('image');
      //const ipAndPort = location.host.split(':');
      //console.log(ipAndPort);
      const url = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`;
      console.log(url);
      const connection = new WebSocket(url, "echo-protocol");
      const inputField = document.getElementById('framerate');
      const button = document.getElementById('bla');

      //await new Promise()

      connection.onopen = function(event) {

      };

	    connection.onmessage = function (event) {
        console.log(event.data);
        const m8 = URL.createObjectURL(event.data);
        image.src = m8;
        //image.src = 'data:image/jpeg;base64,'+ event.data;
      };

      connection.onclose = function(event) {
          
      };

      connection.onerror = function(event) {
          console.log(event);
      };

      inputField.addEventListener("keyup", (event) => {
        if (event.keyCode === 13) {
          event.preventDefault();
          button.click();
        }
      });

      function sendFramerate() {
          const parsed = Number.parseInt(inputField.value, 10);
          if(!Number.isNaN(parsed)) connection.send(parsed);
      }

      async function toggleLed() {
        const now = Date.now();
        if((now - lastTime) > ledToggleTimeout) { 
          await fetch(`${location.protocol}//${location.host}/toggle`, {method: 'POST'});
          lastTime = now;
        }
      }
  </script>
  </body>
</html>
